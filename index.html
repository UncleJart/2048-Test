<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>2048 Test</title>
</head>
<style>
	.slide{
		display: flex;
		width: 1024px;
		height: 768px;
		background-color: lightgrey;
	}

	.game-field{
		margin: auto;
		display: flex;
		flex-flow: column wrap;
		justify-content: space-around;
		width: 480px;
		height: 480px;
	}

	.column{
		display: flex;
		flex-flow: row nowrap;
		width: 480px;
		justify-content: space-around;
	}

	.square{
		border: 1px solid black;
		width: 100px;
		height: 100px;
		background-color: grey;
	}
</style>
<body>
	<article class="slide">
		<div id="gameField" class="game-field">
			<div class="column">
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
			</div>
			<div class="column">
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
			</div>
			<div class="column">
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
			</div>
			<div class="column">
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
			</div>
		</div>
	</article>
</body>
<script>
	var columnArray = [],
		valuesArray = [2,4];

//Utils
	function getRandom(min, max) {
		return Math.random() * (max - min) + min;
	}

	function getRoundedRandom(min,max,rounded){
		return rounded ?
				Math.round(getRandom(min,max)) :
				Math.floor(getRandom(min,max))
	}

	function decreaseArraySorting(a, b) {
		if (a > b){
			return -1;
		}
		if (a < b){
			return 1;
		}
		if (a = b){
			return 0;
		}
	}

	function increaseArraySorting(a, b) {
		if (a > b){
			return -1;
		}
		if (a < b){
			return 1;
		}
		if (a = b){
			return 0;
		}
	}
//Constructors
	function StartValues(options){
		this.startValues = [];

		options.values.forEach(function(item,i){
			var valueOpts = {};

			valueOpts.value = item;
			valueOpts.probability = options.probability[i];
			this.startValues.push(valueOpts);
		},this);
	}

	StartValues.prototype.getValue = function(){
		var startValue,
			probabilities = [],
			random = Math.random(),
			that = this;

		this.startValues.forEach(function(item){
			probabilities.push(item.probability);
		});

		probabilities.sort(decreaseArraySorting);

		probabilities.reduce(function(prev,curr,i){
			if (random > prev && random < (prev + curr)){
				startValue = that.startValues[i].value;
			}
			return prev + curr;
		},0);

		return startValue;

	};
//Objects for creating Game Field
	function RowArray(numOfRows,startValue){
		var counter;

		this.rowArray = [];

		for(counter = 0; counter < numOfRows; counter++){
			this.rowArray.push(startValue);
		}
	}

	function GameField(numOfRows,numOfColumns,elementValues,numOfStartElements){
		var counter,
			startValue = "";

		numOfStartElements = numOfStartElements || 2;

		this.columnArray = [];
		this.startValue = startValue;
		this.elementValues = new StartValues(elementValues);
		this.numOfStartElelements = numOfStartElements;

		for(counter = 0; counter < numOfColumns; counter++){
			this.columnArray.push(new RowArray(numOfRows,startValue));
		}
	}
//Methods of Game Field
//Генерация элемента
	GameField.prototype.generateElement = function(){
		var position,column,row;

		do{
			position = this.generateElementPosition();
			column = position[0];
			row = position[1];
		}while(!this.checkIfElementIsEmpty(position));

		this.columnArray[column].rowArray[row] = this.elementValues.getValue();

		return position;

	};
//Генерация стартовых элементов
	GameField.prototype.generateStartElements = function(){
		var counter;

		for(counter = 1; counter<=this.numOfStartElelements; counter++){
			this.generateElement();
		}
		printArray(this);
	};
//Проверка на пустое поле, т.е. равно ли поле начальному значению
	GameField.prototype.checkForEmptyGameField = function(){
		return this.columnArray.every(function(item){
			return item.rowArray.every(function(item){
				return item === this.startValue;
			},this);
		},this);
	};
//Генерация случайной позиции элемента
	GameField.prototype.generateElementPosition = function(){
		var position = [],
			columns = this.columnArray.length - 1,
			rows = this.columnArray[0].rowArray.length - 1;

		position.push(getRoundedRandom(0,columns,true));
		position.push(getRoundedRandom(0,rows,true));

		return position;
	};
//Проверка на соответствие элемента начальному значению
	GameField.prototype.checkIfElementIsEmpty = function(position){
		var column = position[0],
			row = position[1];
		return this.columnArray[column].rowArray[row] === this.startValue;
	};
//Сдвиг элементов горизонтально (вправо или влево)
	GameField.prototype.moveHorizontally = function(moveStraight){
		var that = this;
		this.columnArray.forEach(function(item){
			var row = item.rowArray,
				options = {};

			if(moveStraight){
				options.startPoint = row.length - 1;
				options.endPoint = 0;
				options.step = -1;
				options.check = function(cnt){
					return cnt >= this.endPoint;
				}
			}else{
				options.startPoint = 0;
				options.endPoint = row.length - 1;
				options.step = 1;
				options.check = function(cnt){
					return cnt <= this.endPoint;
				}
			}

			row = moveElementsOfArray(this,row,options);

		},this);
		printArray(this);
	};
//Ф-ии для сдвига элементов массива
	function moveElementsOfArray(targetObj,array,options){
		var cnt,
				startPoint = options.startPoint,
				endPoint = options.endPoint,
				step = options.step,
				startValue = targetObj.startValue,
				lastEmptyElementPos = null;

		for(cnt = startPoint; options.check(cnt); cnt += step){

			lastEmptyElementPos = setStartEmptyElement(array,startValue,cnt,lastEmptyElementPos);

			if(array[cnt] !== startValue && cnt !== startPoint){
				if(lastEmptyElementPos !== null){
					lastEmptyElementPos = getLatestEmptyElementPos(startPoint,endPoint,array,startValue,lastEmptyElementPos);
					array[lastEmptyElementPos] = array[cnt];
					array[cnt] = targetObj.startValue;
					lastEmptyElementPos = cnt;
				}
			}
		}
		return array;
	}

	function setStartEmptyElement(array,startValue,cnt,lastEmptyElementPos){
		if(array[cnt] === startValue){
			if(lastEmptyElementPos === null){
				lastEmptyElementPos = cnt;
			}
		}
		return lastEmptyElementPos;
	}

	function getLatestEmptyElementPos(startPoint,endPoint,array,startValue,lastEmptyElementPos){
		if(startPoint > endPoint) {
			lastEmptyElementPos = checkForMultipleEmptyElements(array,startValue,lastEmptyElementPos,true);
		}else{
			lastEmptyElementPos = checkForMultipleEmptyElements(array,startValue,lastEmptyElementPos);
		}
		return lastEmptyElementPos;
	}


	function checkForMultipleEmptyElements(array,startValue,lastEmptyElementPos,moveStraight){
		var step;

		if(moveStraight){//Тернарный оператор не сработал
			step = 1;
		}else{
			step = -1;
		}
		while(array[lastEmptyElementPos] === startValue){
			lastEmptyElementPos += step;
		}
		lastEmptyElementPos -= step;
		return lastEmptyElementPos;
	}

//Ф-ия для проверки пустых строк

	function printArray(array){
		array.columnArray.forEach(function(item){
			console.log(item.rowArray);
		});
	}

	function startGame(){
		var startOptions = {
			values : [2,4],
			probability :[0.9,0.1]
			},
			gameField = new GameField(4,4,startOptions,8);  //---> to 2

		console.log(gameField.generateStartElements());


		document.addEventListener("keyup",function(event){
			var keyCode = event.keyCode;

			event.preventDefault();

			switch(keyCode) {
				case 38:
				{
					console.log("up");
					break;
				}
				case 40:
				{
					console.log("down");
					break;
				}
				case 37:
				{
					console.log("left");
					gameField.moveHorizontally();
					break;
				}
				case 39:
				{
					console.log("right");
					gameField.moveHorizontally(true);
					break;
				}
			}
		});
	}

	startGame();

</script>
</html>